<!DOCTYPE html>
<html lang="en-CA">
    <head>
        <meta charset="utf-8">
        <link rel="icon" type="image/x-icon" href="/assets/favicon/favicon.ico">
        <link rel="stylesheet" href="/assets/css/style.css" type="text/css">
        <style>
            .delta-pos { color: #6dd47e; }
            .delta-neg { color: #f76c6c; }
            .delta-zero { color: #bbb; }
        </style>
        <title>TMW Quizzes | Cole Shanks</title>
    </head>
    <body style="margin-bottom: 20px; background-size: cover; padding-top: 80px;">
        <button class="back-to-main"><a href="/pages/JET_japan.html" target="_self">back to main</a></button>
        <h2 style="margin-top: 10px;">The Moe Way Sunday Quizzes</h2>
        <p>Weekly Sunday runs toward Idol ranks. One row per attempt; ranks side-by-side. Scores are out of 50 by default. Best row is auto-calculated from the attempts below.</p>

        <table id="tmw-quizzes" style="width: 100%; border-collapse: collapse; text-align: left; margin-top: 16px;">
            <thead>
                <tr>
                    <th style="border-bottom: 1px solid #555; padding: 8px 6px;">Date (Sun)</th>
                    <th style="border-bottom: 1px solid #555; padding: 8px 6px;">Debut</th>
                    <th style="border-bottom: 1px solid #555; padding: 8px 6px;">Major</th>
                    <th style="border-bottom: 1px solid #555; padding: 8px 6px;">Prima</th>
                    <th style="border-bottom: 1px solid #555; padding: 8px 6px;">Divine</th>
                    <th style="border-bottom: 1px solid #555; padding: 8px 6px;">Eternal</th>
                </tr>
            </thead>
            <tbody>
                <tr class="best-row">
                    <td style="padding: 8px 6px; border-bottom: 1px solid #333; font-weight: bold;">Best</td>
                    <td style="padding: 8px 6px; border-bottom: 1px solid #333; font-weight: bold;"></td>
                    <td style="padding: 8px 6px; border-bottom: 1px solid #333; font-weight: bold;"></td>
                    <td style="padding: 8px 6px; border-bottom: 1px solid #333; font-weight: bold;"></td>
                    <td style="padding: 8px 6px; border-bottom: 1px solid #333; font-weight: bold;"></td>
                    <td style="padding: 8px 6px; border-bottom: 1px solid #333; font-weight: bold;"></td>
                </tr>
            </tbody>
        </table>
        <script>
            (async function() {
                const table = document.getElementById('tmw-quizzes');
                if (!table) return;

                const tbody = table.querySelector('tbody');
                if (!tbody) return;

                const bestRow = tbody.querySelector('tr.best-row');
                if (!bestRow) return;

                // Fetch data
                let attempts = [];
                try {
                    const res = await fetch('/assets/data/tmw_quizzes.json', { cache: 'no-store' });
                    if (!res.ok) throw new Error(`HTTP ${res.status}`);
                    const json = await res.json();
                    if (Array.isArray(json)) attempts = json;
                } catch (err) {
                    console.warn('Failed to load /assets/data/tmw_quizzes.json', err);
                    // If data can't be loaded, keep the page usable with just the Best row.
                    return;
                }

                // Render rows from JSON (same table layout as before)
                const cellStyle = 'padding: 8px 6px; border-bottom: 1px solid #333;';
                const toCellText = (v) => (v === null || v === undefined ? '' : String(v));

                attempts.forEach((a) => {
                    const tr = document.createElement('tr');

                    const tdDate = document.createElement('td');
                    tdDate.setAttribute('style', cellStyle);
                    tdDate.textContent = toCellText(a.date);
                    tr.appendChild(tdDate);

                    const cols = ['debut', 'major', 'prima', 'divine', 'eternal'];
                    cols.forEach((k) => {
                        const td = document.createElement('td');
                        td.setAttribute('style', cellStyle);
                        td.textContent = toCellText(a[k]);
                        tr.appendChild(td);
                    });

                    tbody.appendChild(tr);
                });

                // --- Existing functionality below (Best + deltas), now operating on rendered rows ---

                const dataRows = Array.from(tbody.querySelectorAll('tr')).filter(
                    (row) => !row.classList.contains('best-row')
                );

                const bestCells = Array.from(bestRow.querySelectorAll('td')).slice(1);
                const bestValues = new Array(bestCells.length).fill(null);

                dataRows.forEach((row) => {
                    const cells = Array.from(row.querySelectorAll('td')).slice(1);
                    cells.forEach((cell, idx) => {
                        const num = parseInt(cell.textContent.trim(), 10);
                        if (!Number.isNaN(num)) {
                            bestValues[idx] = bestValues[idx] === null ? num : Math.max(bestValues[idx], num);
                        }
                    });
                });

                bestValues.forEach((val, idx) => {
                    bestCells[idx].textContent = val !== null ? val : '';
                });

                // Add delta for the most recent filled row compared to the prior filled row
                const filledRows = dataRows.filter((row) => {
                    const vals = Array.from(row.querySelectorAll('td')).slice(1).map((c) => parseInt(c.textContent.trim(), 10));
                    return vals.some((v) => !Number.isNaN(v));
                });

                if (filledRows.length >= 2) {
                    const currentRow = filledRows[filledRows.length - 1];
                    const prevRow = filledRows[filledRows.length - 2];

                    const currentCells = Array.from(currentRow.querySelectorAll('td')).slice(1);
                    const prevCells = Array.from(prevRow.querySelectorAll('td')).slice(1);

                    currentCells.forEach((cell, idx) => {
                        const currVal = parseInt(cell.textContent.trim(), 10);
                        const prevVal = parseInt(prevCells[idx].textContent.trim(), 10);
                        if (Number.isNaN(currVal) || Number.isNaN(prevVal)) return;

                        const delta = currVal - prevVal;
                        const span = document.createElement('span');
                        span.style.marginLeft = '6px';

                        if (delta > 0) {
                            span.className = 'delta-pos';
                            span.textContent = `(+${delta})`;
                        } else if (delta < 0) {
                            span.className = 'delta-neg';
                            span.textContent = `(${delta})`;
                        } else {
                            span.className = 'delta-zero';
                            span.textContent = '(0)';
                        }

                        cell.appendChild(span);
                    });
                }
            })();
        </script>
    </body>
</html>
